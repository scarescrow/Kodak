<!DOCTYPE html>
<html>
<head>
	<title>Kodak</title>
	<link rel="stylesheet" href="css/materialize.min.css">
	<link rel="stylesheet" href="css/style.css"/>
</head>
<body>
	<div class="container" id="complete-card">
        <div class="card">
            <div class="card-image">
                <img id="mainImage"/>
                <span class="card-title" id="mainTitle"></span>
            </div>
            <div class="card-content">
                <p id="mainContent"></p>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        const {firebase} = require('./config');
        const db = firebase.database().ref('posts');
        const $ = require('jquery');
        all_posts = null;
        all_keys = [];
        ctr = 0
        new_posts = false;
        imageTimer = null;
        $('#complete-card').hide();

        $(function() {

            db.once("value", function(snap) {
                imageChanger(all_posts, all_keys, 0);
                new_posts = true;
            });

            db.on("child_added", function(snap, prevKey) {
                if (!all_posts)
                    all_posts = {}
                if (new_posts) {

                    added_post = snap.val()
                    all_posts[snap.key] = added_post;
                    all_keys.unshift(snap.key);
                    ctr = -1;
                    // imageChanger(all_posts, all_keys, 0);
                } else {
                    all_posts[snap.key] = snap.val();
                    all_keys.unshift(snap.key);
                }
            });

            db.on("child_removed", function(snap) {
                delete all_posts[snap.key]
                index = all_keys.indexOf(snap.key);
                all_keys.splice(index, 1);
                ctr = -1;
                // imageChanger(all_posts, all_keys, 0)
            });


        });

        function imageChanger() {
            try {
                if (ctr >= all_keys.length || ctr < 0)
                    ctr = 0;
                post = all_posts[all_keys[ctr]];
                updateCard(post.src, post.title, post.desc, function() {
                    ctr += 1;
                    imageTimer = setTimeout(imageChanger, 5000);
                });
            } catch(e) {
                console.log("Error", e);
                console.log("Ctr and length", ctr, all_keys.length);
                console.log("Posts", all_posts);
                console.log("Keys", all_keys);
            }
        }

        function stopTimer() {
            clearTimeout(imageTimer);
        }

        function updateCard(src, title, content, callback) {
            $('#complete-card').fadeOut(3000, function() {
                $('#mainImage').attr("src", "");
                $('#mainImage').attr("src", src);
                $('#mainTitle').text(title);
                $('#mainContent').text(content);
                $('#complete-card').fadeIn(3000, function() {
                    callback();
                });
            });
        }
    </script>
</body>
</html>